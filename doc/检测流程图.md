# 设备检测流程图

## 📊 完整检测流程

```
┌─────────────────────────────────────────────────────────────┐
│                     🎯 开始检测                              │
│                  (Start Detection)                          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              🔵 基础检测层 (Basic Detection)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 触控检测      │  │ Apple特征    │  │ Android特征  │     │
│  │ Touch +2     │  │ Apple +4~6   │  │ Android +3~4 │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ WebGL指纹    │  │ 桌面API      │  │ 屏幕尺寸     │     │
│  │ WebGL +4~6   │  │ Desktop +1~4 │  │ Screen +5    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              📊 分数统计 (Score Calculation)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  累计各系统分数:                                             │
│  ┌─────────────────────────────────────────────────┐       │
│  │ iOS:     ████████████████ 15                    │       │
│  │ Android: ████████ 8                             │       │
│  │ Windows: █████ 5                                │       │
│  │ macOS:   ███ 3                                  │       │
│  │ iPadOS:  ██ 2                                   │       │
│  │ Linux:   █ 1                                    │       │
│  └─────────────────────────────────────────────────┘       │
│                                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ 是否平分?     │
                  │ (Tie?)       │
                  └──┬────────┬──┘
                     │        │
                 YES │        │ NO
                     │        │
                     ▼        └──────────────┐
            ┌────────────────┐               │
            │ UA二次判定      │               │
            │ (UA Decision)  │               │
            └────────┬───────┘               │
                     │                       │
                     └───────────┬───────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────┐
│          🟢 高级检测层 (Advanced Detection) [可选]           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────────┐  ┌──────────────────────┐        │
│  │   Client Hints       │  │   PASSKEY检测 ⭐     │        │
│  │   (浏览器提示)        │  │   (硬件级验证)        │        │
│  │   权重: +5           │  │   权重: +8           │        │
│  └──────────────────────┘  └──────────────────────┘        │
│                                                             │
│  ┌─────────────────────────────────────────────────┐       │
│  │ 结果对比 (Compare with Basic Detection)         │       │
│  └─────────────────────────────────────────────────┘       │
│                                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ 结果是否一致? │
                  │ (Consistent?)│
                  └──┬────────┬──┘
                     │        │
                 YES │        │ NO
                     │        │
                     ▼        ▼
         ┌──────────────┐  ┌──────────────┐
         │ ✅ 正常检测   │  │ ⚠️ 疑似篡改   │
         │ 置信度: 95%  │  │ 置信度: 25%  │
         │ (Normal)     │  │ (Tampered)   │
         └──────┬───────┘  └──────┬───────┘
                │                 │
                └────────┬────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              🎯 输出最终结果 (Output Result)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────┐       │
│  │ 操作系统: iOS                                    │       │
│  │ 置信度: 95%                                      │       │
│  │ 检测方法: 基础检测 + PASSKEY验证                 │       │
│  │ 状态: ✅ 正常                                    │       │
│  └─────────────────────────────────────────────────┘       │
│                                                             │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐            │
│  │  📱  │ │  🤖  │ │  💻  │ │  🍎  │ │  🐧  │            │
│  │ iOS  │ │Android│ │Windows│ │macOS │ │Linux │            │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 详细检测步骤

### 步骤1: 基础检测（自动执行）

```
输入设备检测
├─ navigator.maxTouchPoints > 0? 
│  ├─ YES → 移动设备倾向 (+2分)
│  └─ NO → 桌面设备倾向 (+2分)
│
Apple生态检测
├─ 'ApplePaySession' in window?
│  ├─ YES → iOS/iPadOS/macOS (+4分)
│  └─ NO → 其他系统
│
├─ CSS.supports('-webkit-touch-callout')?
│  ├─ YES → iOS/iPadOS (+5分)
│  └─ NO → 其他系统
│
├─ DeviceMotionEvent.requestPermission?
│  ├─ YES → iOS/iPadOS (+6分)
│  └─ NO → 其他系统
│
Android特征检测
├─ 'NDEFReader' in window?
│  ├─ YES → Android (+4分)
│  └─ NO → 其他系统
│
WebGL指纹检测
├─ 获取 UNMASKED_RENDERER_WEBGL
│  ├─ 含 "apple" → macOS/iOS (+6分)
│  ├─ 含 "direct3d" → Windows (+6分)
│  ├─ 含 "mesa" → Linux (+5分)
│  └─ 含 "adreno"/"mali" → Android (+4分)
```

### 步骤2: 分数计算与裁决

```
计算各系统总分
├─ iOS: 15分
├─ Android: 8分
├─ Windows: 5分
└─ ...

检查是否平分
├─ 单一最高分 → 直接输出
└─ 多个并列 → UA二次判定
   ├─ 检查 navigator.userAgent
   │  ├─ 含 "iPhone" → iOS
   │  ├─ 含 "Android" → Android
   │  ├─ 含 "Windows NT" → Windows
   │  └─ ...
   └─ 输出最终结果
```

### 步骤3: 高级检测（用户触发）

```
用户点击"高级检测"按钮
│
├─ Client Hints检测
│  ├─ navigator.userAgentData可用?
│  │  ├─ YES → 获取平台信息 (+3~5分)
│  │  └─ NO → 跳过
│  │
│  └─ 从API获取:
│     ├─ platform (低熵)
│     ├─ mobile (低熵)
│     └─ platformVersion, architecture (高熵)
│
├─ PASSKEY检测
│  ├─ PublicKeyCredential可用?
│  │  ├─ YES → 继续检测
│  │  └─ NO → 显示不支持提示
│  │
│  ├─ 检查平台认证器
│  │  └─ isUserVerifyingPlatformAuthenticatorAvailable()
│  │
│  ├─ 尝试创建凭据 (3秒超时)
│  │  ├─ 成功 → 获取传输方式 (+8分)
│  │  └─ 失败 → 基于UA推断
│  │
│  └─ 分析传输方式:
│     ├─ "internal" → Touch ID/Face ID/Windows Hello
│     ├─ "hybrid" → 混合认证
│     └─ "usb"/"nfc"/"ble" → 其他
│
└─ 结果对比
   ├─ 基础检测: iOS
   ├─ 高级检测: iOS
   │  ├─ 一致 → 置信度95% ✅
   │  └─ 不一致 → 疑似篡改25% ⚠️
   │
   └─ 输出最终结果
```

---

## 🎨 可视化展示

### 检测过程实时显示

```
┌─────────────────────────────────────┐
│ 检测结果                             │
├─────────────────────────────────────┤
│ 正在分析系统特征...                  │
│                                     │
│ 置信度: ████████████░░░░░░░░ 75%   │
│                                     │
│ 系统评分:                            │
│ iOS      ████████████████ 15       │
│ Android  ████████ 8                │
│ Windows  █████ 5                   │
│ macOS    ███ 3                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 检测过程                             │
├─────────────────────────────────────┤
│ ✅ 触发 | 权重 2 | iOS·iPadOS·Android│
│ 触控/粗指针环境                      │
│ maxTouchPoints=5, coarse=true       │
│                                     │
│ ✅ 触发 | 权重 5 | iOS·iPadOS       │
│ iOS/iPadOS WebKit 移动端 CSS 特性   │
│ -webkit-touch-callout               │
│                                     │
│ ✅ 触发 | 权重 4 | iOS·iPadOS·macOS │
│ Apple Pay API                       │
│ Safari 系列可用                      │
│                                     │
│ ✅ 触发 | 权重 6 | iOS·iPadOS       │
│ iOS 权限 API 形态                    │
│ DeviceMotionEvent.requestPermission │
└─────────────────────────────────────┘
```

---

## 🔀 决策树

```
开始
  │
  ├─ 有触控? ──YES→ 移动设备路径
  │           │
  │           ├─ Apple特征? ──YES→ iOS/iPadOS
  │           │               │
  │           │               ├─ 屏幕≥600px? ──YES→ iPadOS
  │           │               └─ 屏幕<600px? ──YES→ iOS
  │           │
  │           └─ Android特征? ──YES→ Android
  │
  └─ 无触控? ──YES→ 桌面设备路径
              │
              ├─ Apple特征? ──YES→ macOS
              │
              ├─ Direct3D? ──YES→ Windows
              │
              └─ Mesa/X11? ──YES→ Linux
```

---

## 📈 置信度评估流程

```
计算置信度
  │
  ├─ 获取最高分 (topScore)
  ├─ 获取第二高分 (secondScore)
  ├─ 计算差距 (gap = topScore - secondScore)
  │
  └─ 评估置信度:
     │
     ├─ topScore≥15 且 gap≥8 → 98% (超高)
     ├─ topScore≥12 且 gap≥6 → 95% (很高)
     ├─ topScore≥10 且 gap≥5 → 92% (高)
     ├─ topScore≥8 且 gap≥4 → 88% (较高)
     ├─ topScore≥6 且 gap≥3 → 82% (中高)
     ├─ topScore≥5 且 gap≥2 → 75% (中等)
     ├─ gap≥2 → 68% (中低)
     ├─ gap≥1 → 58% (低)
     └─ gap<1 → 45% (很低)
```

---

## 🔐 安全检查流程

```
高级检测完成
  │
  ├─ 获取基础检测结果 (basicOS)
  ├─ 获取高级检测结果 (advancedOS)
  │
  └─ 对比结果:
     │
     ├─ basicOS == advancedOS
     │  └─ ✅ 正常 (置信度95%)
     │
     └─ basicOS != advancedOS
        └─ ⚠️ 疑似篡改
           ├─ 置信度降至25%
           ├─ 应用红色主题
           ├─ 显示安全警告
           └─ 以高级检测结果为准
```

---

## 🎯 最终输出格式

```json
{
  "detectedOS": "ios",
  "confidence": 95,
  "method": "基础检测 + PASSKEY验证",
  "scores": {
    "ios": 15,
    "android": 8,
    "windows": 5,
    "macos": 3,
    "ipados": 2,
    "linux": 1
  },
  "signals": {
    "touchPoints": 5,
    "applePay": true,
    "webkitTouchCallout": true,
    "iOSPermissionShape": true,
    "webGL": {
      "vendor": "Apple Inc.",
      "renderer": "Apple GPU"
    }
  },
  "advancedDetection": {
    "clientHints": {
      "platform": "iOS",
      "mobile": true
    },
    "passkey": {
      "supported": true,
      "platformAuthenticator": true,
      "osFromCertificate": "ios"
    }
  },
  "status": "normal",
  "timestamp": "2025-11-25T09:40:14+08:00"
}
```

---

**文档说明**：
- 本流程图展示了完整的设备检测流程
- 包含基础检测、高级检测、结果对比等所有环节
- 可用于理解项目的整体架构和执行逻辑
